#compdef mytool

_mytool_subcommands() {
  local -a subcmds
  subcmds=(
    "init:Initialize a new project"
    "build:Build the project"
    "deploy:Deploy the project"
  )
  _describe -t subcommands 'subcommands' subcmds
}

_git_branches() {
  local branches
  branches=("${(f)$(git for-each-ref --format='%(refname:short)' refs/heads)}")
  _values 'branch' $branches
}

_git_commits() {
  local -a choices
  local line opt msg

  while IFS= read -r line; do
    opt="${line%% *}"
    msg="${line#* }"
    choices+=("$opt:$msg")
  done < <(git log --oneline -n 20 --format='%h %s')
  _describe -t choices 'choices' choices
}

_mytool() {
  local state

  _arguments -C \
    '(--verbose -v)'{--verbose,-v}'[Enable verbose output]' \
    '(--config -c)'{--config,-c}'[Config file path]:FILE:_files' \
    '1: :->cmds' \
    '*:: :->args'

  case $state in
    cmds)
      _mytool_subcommands
      ;;
    args)
      case $words[1] in
        init)
          _arguments \
            '(--template -t)'{--template,-t}'[Template to use]' \
            '(--force -f)'{--force,-f}'[Force overwrite existing files]' \
            '1:GitCommits:_git_commits'
          ;;
        build)
          _arguments \
            '(--output -o)'{--output,-o}'[Output directory]:DIR:_files -/' \
            '(--optimize -O)'{--optimize,-O}'[Optimization level]' \
            '1:GitBranches:_git_branches' \
            '2:GitCommits:_git_commits'
          ;;
        deploy)
          _arguments \
            '(--server -s)'{--server,-s}'[Server to deploy to]' \
            '(--dry-run)'--dry-run'[Show what would be deployed]' \
            '1:Default:_default'
          ;;
      esac
      ;;
  esac
}

_mytool
